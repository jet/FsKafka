name: $(Rev:r)

# Summary:
#	Linux: Tests using docker Kafka instance (note test suite does not run net framework as CK on mono is not supported)
#	Windows: Builds and emits nupkg as artifacts
#	MacOS: Builds only

jobs:
# - job: Windows
#   pool:
#     vmImage: 'windows-latest'
#   steps:
#   - script: dotnet pack build.proj
#     displayName: dotnet pack build.proj
#     env:
#       BUILD_PR: $(SYSTEM.PULLREQUEST.PULLREQUESTNUMBER)
#       BUILD_ID: $(BUILD.BUILDNUMBER)
#   - task: PublishBuildArtifacts@1
#     inputs:
#       pathtoPublish: 'bin'
#       artifactName: 'nupkgs'

- job: Linux
  pool:
    vmImage: 'ubuntu-latest'
  strategy:
    maxParallel: 2
    matrix:
      GlobalJson:
        dotnetGlobalJson: true
      Net10:
        dotnetGlobalJson: false
        dotnetVersion: '10.x'
  steps:
    - task: UseDotNet@2
      displayName: 'Install .NET SDK (global.json)'
      condition: eq(variables['dotnetGlobalJson'], 'true')
      inputs:
        packageType: sdk
        useGlobalJson: true
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      condition: eq(variables['dotnetGlobalJson'], 'false')
      inputs:
        packageType: sdk
        version: $(dotnetVersion)
    - script: |
        docker network create kafka-net
        docker run -d --name zookeeper --network kafka-net --publish 2181:2181 zookeeper:3.4
        docker run -d --name kafka --network kafka-net --hostname localhost --publish 9092:9092 \
            --env KAFKA_ADVERTISED_HOST_NAME=127.0.0.1 --env ZOOKEEPER_IP=zookeeper \
            --env KAFKA_AUTO_CREATE_TOPICS_ENABLE=true \
            ches/kafka
        sleep 15
      displayName: Docker kafka for integration tests
    - script: dotnet test build.proj -v d
      displayName: Run Integration tests
      env:
        TEST_KAFKA_BROKER: localhost:9092
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: 'tests/**/*.trx'
      condition: succeededOrFailed()

# - job: MacOS
#   pool:
#     vmImage: 'macOS-latest'
#   steps:
#   - task: UseDotNet@2
#     displayName: 'Install .NET Core sdk'
#     inputs:
#       packageType: sdk
#       useGlobalJson: true
#   - script: dotnet pack build.proj
#     displayName: dotnet pack build.proj
